#!/bin/bash

if [ -z "$1" ]; then
    echo "ERROR: The card device name is needed as a parameter"
    exit 1
fi

DEVICE=$1

IMG_URL="http://dev.kano.me/public/Kanux-Beta-v1.3.2-release-8gb.img"
if [ -n "$2" ]; then
    IMG_URL="$2"
fi

for part in `ls ${1}*`; do
    echo "Umounting $part..."
    sudo umount $part
done

if [ "$IMG_URL" == "--cached" ]; then
    echo "Skipping download and using cached files"
else
    echo "Downloading the OS image. This might take a good while ..."
    rm -rf ~/kano/*
    mkdir -p ~/kano
    curl "$IMG_URL".gz | gunzip -c >~/kano/os.img
    wget -O ~/kano/metadata.json "$IMG_URL".json
fi

if [ ! -e ~/kano/os.img ] || [ ! -e ~/kano/metadata.json ]; then
    echo "ERROR: Failed to download the image. Please try again."
    exit 1
fi

echo "Burning the image to the card. This might take a while ..."
pv ~/kano/os.img | sudo dd of=$DEVICE bs=4M

echo "Calculating the checksum."
orig_md5=`json-get ~/kano/metadata.json uncompressed_md5`
echo "ORIGINAL checksum: $orig_md5"

dev_md5=`sudo md5sum $DEVICE | cut -c -32`
echo "CARD checksum: $dev_md5"

if [ "$orig_md5" == "$dev_md5" ]; then
    echo "SUCCESS: Production image burned successfully."
else
    echo "FAILED: The checksums don't match."
    exit 1
fi
